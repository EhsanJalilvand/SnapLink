<!-- Persian Datepicker CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
<style>
  .date-picker-container {
    position: relative;
  }
  
  .date-input-trigger {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    background-color: #fff;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .date-input-trigger:hover {
    border-color: #86b7fe;
  }
  
  .date-input-trigger i {
    margin-left: 0.5rem;
    color: #6c757d;
  }
  
  .date-input-hidden {
    position: absolute;
    opacity: 0;
    height: 0;
    width: 0;
  }
  
  .form-switch .form-check-input {
    width: 2.5em;
    height: 1.5em;
    margin-left: 0;
  }
  
  /* Persian Calendar Adjustments */
  .persian-datepicker {
    font-family: 'Vazir', Tahoma, sans-serif !important;
    z-index: 1060 !important;
  }
  
  .persian-datepicker-rtl {
    direction: rtl;
  }
</style>

<div class="modal fade" id="datePickerModal" tabindex="-1" aria-labelledby="datePickerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      
      <!-- Header -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="datePickerModalLabel">
          <i class="fas fa-calendar-day me-2"></i>
          <%= lang === 'fa' ? 'انتخاب تاریخ' : 'Select Date' %>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <div class="date-picker-container mb-3">
          <!-- Hidden Date Input -->
          <input type="text" id="datepickerWidget" class="date-input-hidden" />
          
          <!-- Visible Trigger -->
          <div class="date-input-trigger" id="dateInputTrigger">
            <i class="fas fa-calendar-alt me-2"></i>
            <span id="dateDisplayText" >
            
            </span>
          </div>
        </div>

        <!-- Disable Date Switch -->
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="disableDateSwitch" />
          <label class="form-check-label" for="disableDateSwitch">
            <i class="fas fa-power-off me-2"></i>
            <%= lang === 'fa' ? 'غیرفعال کردن تاریخ' : 'Disable Date' %>
          </label>
        </div>
        
        <input type="hidden" id="finalDateValue" />
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>
          <%= lang === 'fa' ? 'انصراف' : 'Cancel' %>
        </button>
        <button type="button" class="btn btn-primary" id="confirmDateBtn">
          <i class="fas fa-check me-2"></i>
          <%= lang === 'fa' ? 'تأیید' : 'Confirm' %>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JS Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.0.6/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

<script>
$(function() {
  // Initialize datepicker
  const initDatePicker = () => {
    const isPersian = <%= lang === 'fa' ? 'true' : 'false' %>;
    const dateFormat = isPersian ? "YYYY/MM/DD" : "YYYY-MM-DD";
    
    $("#datepickerWidget").persianDatepicker({
      format: dateFormat,
      initialValue: false,
      autoClose: true,
      calendarType: isPersian ? "persian" : "gregorian",
      toolbox: {
        calendarSwitch: { enabled: false }
      },
      onSelect: function(unix) {
        const dateText = new persianDate(unix).format(dateFormat);
        $("#dateDisplayText").text(dateText);
        $("#finalDateValue").val(dateText);
      }
    });
    
    // Trigger datepicker when clicking on the visible element
    $("#dateInputTrigger").click(function() {
      $("#datepickerWidget").focus();
    });
  };

  // Toggle date input
  $("#disableDateSwitch").change(function() {
    const isDisabled = $(this).prop('checked');
    $("#dateInputTrigger").toggleClass("bg-light", isDisabled);
    
    if(isDisabled) {
      $("#dateDisplayText").text(
        '<%= lang === 'fa' ? 'تاریخ غیرفعال شد' : 'Date disabled' %>'
      );
      $("#finalDateValue").val('');
    } else {
      $("#dateDisplayText").text(
        '<%= lang === 'fa' ? 'تاریخ را انتخاب کنید' : 'Select a date' %>'
      );
    }
  });

  // Confirm selection
  $("#confirmDateBtn").click(function() {
    const selectedDate = $("#finalDateValue").val();
    const isDisabled = $("#disableDateSwitch").prop('checked');
    
    if(!isDisabled && !selectedDate) {
      alert(
        '<%= lang === 'fa' ? 
          'لطفاً تاریخ را انتخاب کنید' : 
          'Please select a date' %>'
      );
      return;
    }
    
    console.log("Selected date:", selectedDate || "Date disabled");
    $('#datePickerModal').modal('hide');
  });

  // Initialize
  initDatePicker();
});
</script>