<%- include('./partials/header.ejs') %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.2/build/moment-jalaali.min.js"></script>
    <div class="container-fluid">
        <div class="row">
        
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar">
                <div class="position-sticky pt-3">
                 
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active text-white section-link" href="#" data-section="links-section">
                                <i class="bi bi-link-45deg me-2"></i>
                               Links
                            </a>
                        </li>
                        
                    
                        <li class="border-top my-2"></li>
                        
                        <!-- <li class="nav-item">
                            <a class="nav-link text-white section-link" href="#" data-section="analytics-section">
                                <i class="bi bi-bar-chart-line me-2"></i>
                               Charts
                            </a>
                        </li> -->
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <section id="links-section" class="content-section py-4">

                    <%- include('./partials/shortlink.ejs') %>

              

                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="links-table">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Original Link</th>
                                            <th>Create At</th>
                                            <th>Expire At</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    
                                    </tbody>
                                </table>
                            </div>
                            
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center mt-3" id="pagination">
                               
                                </ul>
                            </nav>
                        </div>
                    </div>
                </section>

             
                <!-- <section id="analytics-section" class="content-section py-4" style="display: none;">
                    <h2 class="h4 mb-4">آمار و تحلیل‌ها</h2>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">تعداد کلیک‌ها در ۷ روز گذشته</h5>
                                    <canvas id="weeklyChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">پربازدیدترین لینک‌ها</h5>
                                    <canvas id="topLinksChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">آمار کلی</h5>
                            <div class="row text-center">
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="p-3 bg-primary bg-opacity-10 rounded">
                                        <h6 class="text-primary">لینک‌های فعال</h6>
                                        <h4 id="active-links">0</h4>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="p-3 bg-success bg-opacity-10 rounded">
                                        <h6 class="text-success">کل کلیک‌ها</h6>
                                        <h4 id="total-clicks">0</h4>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="p-3 bg-info bg-opacity-10 rounded">
                                        <h6 class="text-info">میانگین کلیک</h6>
                                        <h4 id="avg-clicks">0</h4>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="p-3 bg-warning bg-opacity-10 rounded">
                                        <h6 class="text-warning">لینک‌های منقضی شده</h6>
                                        <h4 id="expired-links">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section> -->
            </main>
        </div>
    </div>

  

    <script>
                    window.loadLinksTable=(page = 1)=> {
                $.ajax({
            url: '/links',
            method: 'GET',
            data: { page, pageSize:10 },
            success: (res) => {
                showLinkList(res);
            },
            error: (xhr, status, error) => {
                generateBtn.disabled = false;
                   generateBtn.innerHTML = `
                <i class="fas fa-bolt me-2"></i>
                ${generateBtn.dataset.generateBtn}
            `;

                if (xhr && xhr.status === 401) {
                    window.location.href = xhr.responseJSON.redirect;
                    return;
                }

                const errors = xhr.responseJSON;
                if (errors) {
                    const errorMessage = errors.join('\n');
                    showAlert(errorMessage, 'danger');
                } else {
                    showAlert('An error occurred while generating the link', 'danger');
                }
            }
        });


                const showLinkList=(result)=>{
                    const isPersian = <%= lang === 'fa' ? 'true' : 'false' %>;
                $('#links-table tbody').empty();
                result.items.forEach(link => {
                    const createdAt = isPersian ? 
            moment(link.createdAt).format('jYYYY-jMM-jDD HH:mm') :
            moment(link.createdAt).format('YYYY-MM-DD HH:mm'); 
            
        const expireAt = link.expireAt ? 
            (isPersian ? 
                moment(link.expireAt).format('jYYYY-jMM-jDD HH:mm') : 
                moment(link.expireAt).format('YYYY-MM-DD HH:mm')) : 
            '-'; 
                    $('#links-table tbody').append(`
                        <tr class="link-row"
                            data-id="${link._id}" 
                            data-title="${link.title}" 
                            data-original="${link.originalLink}" 
                            data-short="${link.shortLink}"
                            data-clicks="${link.clicks}">
                            <td>${link.title}</td>
                            <td class="text-truncate" style="max-width: 150px;">${link.originalLink}</td>
                            <td>${createdAt}</td>
                            <td>${expireAt}</td>
                            <td><span class="badge ${link.isEnable ? 'bg-success' : 'bg-danger'}">${link.isEnable ? 'Enable' : 'Disable'}</span></td>
                        </tr>
                    `);
                });
                

                $('#pagination').empty();
                for (let i = 1; i <= result.pageCount; i++) {
                    $('#pagination').append(`
                        <li class="page-item ${i === page ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `);
                }
            }
            }
            
        $(document).ready(function() {

            $('.section-link').click(function(e) {
                e.preventDefault();
                $('.content-section').hide();
                $('#' + $(this).data('section')).show();
                $('.section-link').removeClass('active');
                $(this).addClass('active');
            });


            $(document).on('click', '.link-row', function() {
              
                showLink($(this).data('id'),$(this).data('original'),$(this).data('short'));
  
            });
            
            $(document).on('click', '.page-link', function(e) {
                e.preventDefault();
                loadLinksTable($(this).data('page'));
            });
            
            // const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            // const weeklyChart = new Chart(weeklyCtx, {
            //     type: 'line',
            //     data: {
            //         labels: ['شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه'],
            //         datasets: [{
            //             label: 'تعداد کلیک‌ها',
            //             data: [65, 59, 80, 81, 56, 55, 40],
            //             backgroundColor: 'rgba(108, 99, 255, 0.2)',
            //             borderColor: 'rgba(108, 99, 255, 1)',
            //             borderWidth: 2,
            //             tension: 0.3
            //         }]
            //     },
            //     options: {
            //         responsive: true,
            //         scales: {
            //             y: {
            //                 beginAtZero: true
            //             }
            //         }
            //     }
            // });
            
            // const topLinksCtx = document.getElementById('topLinksChart').getContext('2d');
            // const topLinksChart = new Chart(topLinksCtx, {
            //     type: 'doughnut',
            //     data: {
            //         labels: ['وبلاگ', 'پروژه', 'درباره ما', 'تماس'],
            //         datasets: [{
            //             data: [35, 25, 20, 20],
            //             backgroundColor: [
            //                 'rgba(108, 99, 255, 0.7)',
            //                 'rgba(40, 167, 69, 0.7)',
            //                 'rgba(255, 193, 7, 0.7)',
            //                 'rgba(220, 53, 69, 0.7)'
            //             ]
            //         }]
            //     },
            //     options: {
            //         responsive: true,
            //         plugins: {
            //             legend: {
            //                 position: 'bottom'
            //             }
            //         }
            //     }
            // });
            

            loadLinksTable();
            

            // $('#active-links').text('12');
            // $('#total-clicks').text('1,245');
            // $('#avg-clicks').text('104');
            // $('#expired-links').text('3');
        });
    </script>
    
    <style>

        .sidebar {
            min-height: 100vh;
            transition: all 0.3s;
        }
        .sidebar.collapsed {
            margin-right: -250px;
        }
        main.expanded {
            margin-right: 250px;
        }
        @media (max-width: 767.98px) {
            .sidebar {
                margin-right: -250px;
            }
            .sidebar.collapsed {
                margin-right: 0;
            }
            main.expanded {
                margin-right: 0;
            }
        }
    </style>
    